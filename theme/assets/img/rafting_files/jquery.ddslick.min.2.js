(function(b){function s(a){var c=a.data.obj,d=c.find(".dd-options"),f=d.find("> li").length,b=c.data("ddslick");if(b){var e=b.settings;if(!c.hasClass("on")||!e.enableKeyboard)return!0;var g=d.find("li").index(d.find(".dd-option-hover").parent("li"));if(a.keyCode==e.keyboard[0].down)return d.find("li").eq(g).find("a").removeClass("dd-option-hover"),g=Math.min(f-1,g+1),d.find("li").eq(g).find("a").addClass("dd-option-hover"),x(c,g,"bottom"),b.lastKeyBeforeSelect="down",!1;if(a.keyCode==e.keyboard[0].up)return d.find("li").eq(g).find("a").removeClass("dd-option-hover"),
g=Math.max(0,g-1),d.find("li").eq(g).find("a").addClass("dd-option-hover"),x(c,g,"top"),b.lastKeyBeforeSelect="up",!1;a.keyCode==e.keyboard[0].select?(b.didSelectAnOption="other"!==b.lastKeyBeforeSelect,b.lastKeyBeforeSelect="enter",t(c,g)):a.keyCode==e.keyboard[0].tab?(b.didSelectAnOption="other"!==b.lastKeyBeforeSelect,b.lastKeyBeforeSelect="tab",b.didSelectAnOption&&t(c,g),p(c)):a.keyCode==e.keyboard[0].cancel?p(c):b.lastKeyBeforeSelect="other";return!0}}function x(a,c,d){a=a.find(".dd-options");
var b=a.find("li").eq(c);if(0!=b.length){c=a.height();var h=b.height(),b=b.position(),e=a.scrollTop();"bottom"==d?b.top+h>c&&(e+=b.top+h-c):0>b.top&&(e+=b.top);a.scrollTop(e)}}function t(a,c){var d=a.data("ddslick");if(d.didSelectAnOption){var b=a.find(".dd-selected"),h=b.siblings(".dd-selected-value");a.find(".dd-options");b.siblings(".dd-pointer");var e=a.find(".dd-option").eq(c),g=e.closest("li"),q=d.settings,l=d.settings.data[c];a.find(".dd-option").removeClass("dd-option-selected");e.addClass("dd-option-selected");
d.selectedIndex=c;d.selectedItem=g;d.selectedData=l;"function"==typeof q.onSelected&&0<b.text().length&&q.onSelected.call(this,d);0!=b.text().length&&q.resetmenu||(q.showSelectedHTML?b.html((l.imageSrc?'<img class="dd-selected-image'+("right"==q.imagePosition?" dd-image-right":"")+'" src="'+l.imageSrc+'" />':"")+(l.text?'<label class="dd-selected-text" style="cursor:pointer;">'+l.text+"</label>":"")+(l.description?'<small class="dd-selected-description dd-desc'+(q.truncateDescription?" dd-selected-description-truncated":
"")+'" >'+l.description+"</small>":"")):b.html(l.text));h.val(l.value);d.original.val(l.value).change();a.data("ddslick",d)}p(a)}function y(a){function c(a,c){var e=a.find(".dd-options");void 0===g.naturalHeight&&(g.naturalHeight=e.height());var n=b(window).height(),m=parseInt(e.css("padding-top"),10)+parseInt(e.css("padding-bottom"),10),f=Math.min(g.naturalHeight,0.67*n)-m,h=a.offset(),k=e.css("left"),r;if("bottom"===c){r=0;var p=h.top+f+m+d;if(p>n){var t=f,f=Math.max(q.minimumHeight,n-d-m-h.top),
p=h.top+f+m+d;p>n&&(f=t,r=n-h.top-f-m-d,k=g.original.width())}}else r=-(f+m)/2,0>r+h.top?r=-h.top+d:r+h.top+f+m+d>n&&(r=n-h.top-f-m-d);e.css("left",k).css("top",r).css("height",f);n=e.find(".dd-option-selected").parent("li");0<n.length?(n.find("a").addClass("dd-option-hover"),e.scrollTop(e.scrollTop()+n.position().top-(f+m)/2)):e.scrollTop(0)}var d=30;if(!a.hasClass("dd-disabled")){a.addClass("on");v=w=void 0;var f=a.find(".dd-select"),h=f.siblings(".dd-options"),f=f.find(".dd-pointer"),e=h.is(":visible"),
g=a.data("ddslick"),q=g.settings;b(".dd-container.on").each(function(){this!==a.get(0)&&p(b(this))});e?(h.slideUp("fast"),f.removeClass("dd-pointer-up")):(h.show(),f.addClass("dd-pointer-up"),c(a,q.align),b(document).off("keydown"+g.uniqueId,s).on("keydown"+g.uniqueId,{obj:a},s))}}function p(a){if(a.hasClass("on")){var c=a.data("ddslick");if(c){var d=c.settings;if("function"==typeof d.onClose){var f={cancel:!1,didSelectAnOption:c.didSelectAnOption,lastKeyBeforeSelect:c.lastKeyBeforeSelect};d.onClose.call(a.get(0),
f);if(f.cancel)return}}b(document).off("keydown"+c.uniqueId,s);a.removeClass("on");a.find(".dd-options").slideUp(50);a.find(".dd-pointer").removeClass("dd-pointer-up").removeClass("dd-pointer-up")}}b.fn.ddslick=function(a){if(k[a])return k[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"!==typeof a&&a)b.error("Method "+a+" does not exists.");else return k.init.apply(this,arguments)};var k={},w,v,z=0;defaults={data:[],keepJSONItemsOnTop:!1,height:null,background:"#eee",selectText:"",
defaultSelectedIndex:null,truncateDescription:!0,imagePosition:"left",showSelectedHTML:!0,clickOffToClose:!0,onSelected:function(){},onClose:function(){},defaultTarget:"_blank",resetmenu:!1,enableKeyboard:!0,keyboard:[{up:38,down:40,select:13,cancel:27,tab:9}],minimumHeight:180,align:"center"};ddSelectHtml='<div class="dd-select"><input class="dd-selected-value" type="hidden" /><a class="dd-selected"></a><span class="dd-pointer dd-pointer-down"></span></div>';ddOptionsHtml='<ul class="dd-options"></ul>';
k.init=function(a){return this.each(function(){var c=b.extend({},defaults,a),d=b(this),f=d.data("ddslick"),h=d.attr("name");if(!f){var e=[];d.find("option").each(function(){var a=b(this),m=a.data();a.attr("data-href")&&!a.attr("data-target")&&a.attr("data-target",c.defaultTarget);e.push({text:b.trim(a.text()),value:a.val(),selected:a.is(":selected")||a.val()==d.val(),description:m.description,imageSrc:m.imageSrc,href:a.attr("data-href"),target:a.attr("data-target")})});c.keepJSONItemsOnTop?b.merge(c.data,
e):c.data=b.merge(e,c.data);for(var f=d,g=b("<div></div>"),k=f[0].attributes,l=0;l<k.length;l++)g.attr(k[l].nodeName,k[l].nodeValue);d.replaceWith(g);d=g;f.insertAfter(d).css("display","none");d.addClass("dd-container").append(ddSelectHtml).append(ddOptionsHtml);b("input",d).attr("name",h);var e=d.find(".dd-select"),u=d.find(".dd-options");c.width&&(u.css({width:c.width}),e.css({width:c.width}),d.css({width:c.width}));null!=c.height&&u.css({height:c.height,overflow:"auto"});b.each(c.data,function(a,
b){u.append("<li><a "+(void 0===b.href?"":'href="'+b.href+'" target="'+b.target+'"')+' class="dd-option '+(b.selected?"dd-option-selected":"")+'">'+(b.value?' <input class="dd-option-value" type="hidden" value="'+b.value+'" />':"")+(b.imageSrc?' <img class="dd-option-image'+("right"==c.imagePosition?" dd-image-right":"")+'" src="'+b.imageSrc+'" />':"")+(b.text?' <label class="dd-option-text" style="cursor:pointer;">'+b.text+"</label>":"")+(b.description?' <small class="dd-option-description dd-desc">'+
b.description+"</small>":"")+"</a></li>")});var s={settings:c,original:f,selectedIndex:-1,selectedItem:null,selectedData:null,uniqueId:".ddslick-"+z++};d.data("ddslick",s);0<c.selectText.length&&null==c.defaultSelectedIndex?d.find(".dd-selected").html(c.selectText):(h=u.find("li").index(u.find(".dd-option-selected").parent("li")),u.find("li").size(),t(d,h));d.find(".dd-select").on("click.ddslick",function(){d.find("ul").find("li").size();y(d)});d.on("click.ddslick",".dd-option",function(a){s.didSelectAnOption=
!0;t(d,b(a.target).closest("li").index())});d.on("mousemove.ddslick",".dd-option",function(a){var c=void 0==w&&void 0==v;if(a.clientX!=w||a.clientY!=v)w=a.clientX,v=a.clientY,c||(u.find(".dd-option-hover").removeClass("dd-option-hover"),b(a.target).closest("a").addClass("dd-option-hover"))});c.clickOffToClose&&(d.on("click.ddslick",function(a){a.stopPropagation()}),b("body").on("mousedown.ddslick",function(a){var e=a.target===c.linkedControl;0!=b(a.target).parents(".dd-container").addBack(".dd-container").length||
e||p(d)}))}})};k.disable=function(){return this.each(function(){b(this).addClass("dd-disabled")})};k.enable=function(){return this.each(function(){var a=b(this);a.hasClass("dd-disabled")&&a.removeClass("dd-disabled")})};k.select=function(a){return this.each(function(){a.index&&(pluginData.didSelectAnOption=!0);t(b(this),a.index)})};k.deselect=function(){return this.each(function(){var a=b(this);a.find(".dd-selected").removeClass("dd-selected");a.find(".dd-option-selected").removeClass("dd-option-selected");
a.find(".dd-option-hover").removeClass("dd-option-hover");a=a.data("ddslick");a.selectIndex=-1;a.selectedItem=null;a.selectedData=null})};k.open=function(){return this.each(function(){var a=b(this),c=a.data("ddslick");c&&(c.didSelectAnOption=!1,y(a))})};k.close=function(){return this.each(function(){var a=b(this);a.data("ddslick")&&p(a)})};k.destroy=function(){return this.each(function(){var a=b(this),c=a.data("ddslick");c&&(c=c.original,a.removeData("ddslick").unbind(".ddslick").replaceWith(c),c.css("display",
""),b(document).off("keydown",s),b("body").off("mousedown.ddslick"))})}})(jQuery);
